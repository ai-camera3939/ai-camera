<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>AI過積載判定</title>

  <!-- TensorFlow / Teachable Machine -->
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest/dist/tf.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@latest/dist/teachablemachine-image.min.js"></script>

  <style>
    body {
      font-family: sans-serif;
      text-align: center;
      background: #f5f5f5;
    }
    video {
      border: 3px solid #333;
      border-radius: 8px;
    }
    .ok {
      color: green;
      font-size: 28px;
      font-weight: bold;
    }
    .ng {
      color: red;
      font-size: 32px;
      font-weight: bold;
    }
    .row {
      margin: 10px 0;
    }
  </style>
</head>

<body>
  <h2>AI過積載判定</h2>

  <div class="row">
    <label>カメラ：</label>
    <select id="cameraSelect"></select>
    <button id="restartBtn">このカメラで開始</button>
  </div>

  <video id="webcam" autoplay playsinline width="360"></video>
  <p id="result">準備中…</p>

  <script>
    const modelURL = "https://teachablemachine.withgoogle.com/models/KCkoAKQR4/";
    const video = document.getElementById("webcam");
    const resultEl = document.getElementById("result");
    const cameraSelect = document.getElementById("cameraSelect");
    const restartBtn = document.getElementById("restartBtn");

    let model, maxPredictions, stream;

    async function setupCamera(deviceId) {
      if (stream) {
        stream.getTracks().forEach(t => t.stop());
      }
      stream = await navigator.mediaDevices.getUserMedia({
        video: { deviceId: deviceId ? { exact: deviceId } : undefined }
      });
      video.srcObject = stream;
      return new Promise(resolve => {
        video.onloadedmetadata = () => resolve();
      });
    }

    async function loadModel() {
      model = await tmImage.load(modelURL + "model.json", modelURL + "metadata.json");
      maxPredictions = model.getTotalClasses();
    }

    async function loop() {
      const prediction = await model.predict(video);
      let best = prediction.reduce((a, b) => a.probability > b.probability ? a : b);

      if (best.className.includes("OK") && best.probability > 0.6) {
        resultEl.textContent = "OK";
        resultEl.className = "ok";
      } else {
        resultEl.textContent = "NG";
        resultEl.className = "ng";
      }
      requestAnimationFrame(loop);
    }

    async function init(deviceId) {
      resultEl.textContent = "モデル読込中…";
      await setupCamera(deviceId);
      await loadModel();
      resultEl.textContent = "判定中…";
      loop();
    }

    async function loadCameras() {
      const devices = await navigator.mediaDevices.enumerateDevices();
      const cams = devices.filter(d => d.kind === "videoinput");
      cams.forEach((cam, i) => {
        const opt = document.createElement("option");
        opt.value = cam.deviceId;
        opt.text = cam.label || `カメラ ${i + 1}`;
        cameraSelect.appendChild(opt);
      });
    }

    restartBtn.onclick = () => {
      init(cameraSelect.value);
    };

    loadCameras();
  </script>
</body>
</html>
